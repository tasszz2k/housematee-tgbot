---
description: Housematee Telegram Bot - Complete application context and business logic
alwaysApply: true
---

# Housematee Telegram Bot

A Telegram bot for housemate management: expense tracking, rent splitting, housework rotation with Google Sheets as the data store.

## Tech Stack

- Go 1.25, gotgbot/v2 (Telegram), Google Sheets API
- Viper (config), Logrus (logging), Cron (scheduler)

## Architecture Overview

```
cmd/main.go         - Entry point, bot init, command registration
commands/           - Telegram command handlers + conversation logic
handlers/           - Business logic (read/write Google Sheets)
models/             - Data structures
services/gsheets/   - Google Sheets API wrapper
config/             - Configuration + Google Sheets cell mappings
enum/               - Constants (commands, states)
utilities/          - Helpers (date, money parsing)
```

---

## Google Sheets Structure

The bot uses a single Google Spreadsheet with multiple sheets:

### Database Sheet
| Cell | Purpose |
|------|---------|
| B2 | Current active sheet name (e.g., "2024_01") |

### Monthly Sheets (e.g., "2024_01")
Created from "Template" sheet. Contains:

**Expenses Section (Columns A-G, starting row 4):**
| Column | Field |
|--------|-------|
| A | ID |
| B | Name |
| C | Amount |
| D | Date |
| E | Payer |
| F | Participants |
| G | Note |

- Cell B2: Next expense ID counter

**Report Section (I3:M9):**
| Row | Category |
|-----|----------|
| 3 | Header (Category, Amount, @user1, @user2, Payer) |
| 4 | Expenses total |
| 5 | Electric |
| 6 | Water |
| 7 | Other Fees |
| 8 | Total Rent |
| 9 | Grand Total |

**Rent Cells (bot writes to):**
- J5: Electric amount
- J6: Water amount
- J7: Other fees (calculated: total - electric - water)
- J8: Total rent
- M8: Payer username

**Balance Section (I13+):**
| Row | Content |
|-----|---------|
| 11 | "Balances" label |
| 12 | Headers (Username, TotalPaid, ExpenseBalance, RentBalance, FinalBalance) |
| 13+ | Per-member data |

**Members Section (O:Q):**
| Cell/Row | Content |
|----------|---------|
| P2 | Number of members |
| Row 3 | Headers (ID, Username, Weight) |
| O4+ | ID (1, 2, ...) |
| P4+ | Username (e.g., @tasszz2k) |
| Q4+ | Weight (for weighted rent splitting) |

### Tasks Sheet (9 columns A-I)
| Column | Field | Description |
|--------|-------|-------------|
| A | ID | Task identifier |
| B | Name | Task name |
| C | Frequency | Days between occurrences |
| D | LastDone | Date last completed |
| E | NextDue | Date next due |
| F | Assignee | Current assignee username |
| G | TurnsRemaining | Turns before rotation |
| H | ChannelId | Telegram channel for notifications |
| I | Note | Additional notes |

- Cell B1: Number of tasks

### Task Weights Section (K:M on Tasks sheet)
| Column | Field |
|--------|-------|
| K | Task ID |
| L | Username |
| M | Weight |

---

## Business Logic

### Expense Management (/splitbill)

**Main Menu Actions:** Add, View, Update, Delete, Report

**Add Expense Flow:**
1. User sends: `name\namount\ndate\npayer` (date/payer optional)
2. Parse amount (supports "k" = thousand, "m" = million)
3. Default date = today, payer = @username
4. If expense name is "rent" -> redirect to /rent command
5. Write to next row in Expenses section
6. Increment next expense ID counter
7. Create initial audit entry in Note: `[DD/MM/YYYY HH:mm]: amount: X ₫ - by @username`
8. Show response with Update/Delete action buttons

**View Expenses:** Returns last 5 expenses from sheet (skips soft-deleted)

**Update Expense Flow:**
1. Show last 5 expenses as selection buttons (skips soft-deleted)
2. User selects expense -> show current values and prompt for new amount
3. User sends new amount (amount-only update)
4. Append audit entry to Note: `[DD/MM/YYYY HH:mm]: update amount: X ₫ - by @username`
5. Show response with Update/Delete action buttons

**Delete Expense Flow:**
1. Show last 5 expenses as selection buttons (skips soft-deleted)
2. User selects expense -> show confirm/cancel buttons
3. On confirm: soft delete - keeps ID, clears other fields
4. Append audit entry to Note: `[DD/MM/YYYY HH:mm]: deleted: name - X ₫ - by @username`
- Soft-deleted expenses are filtered from view/update/delete lists

**Audit Log Example:**
```
[28/01/2026 21:22]: amount: 92,000 ₫ - by @tasszz2k
[28/01/2026 21:23]: update amount: 166,000 ₫ - by @tasszz2k
[28/01/2026 21:23]: deleted: test 3 - 166,000 ₫ - by @tasszz2k
```

**Action Buttons:**
After adding or updating an expense, inline buttons are shown:
- `Update` - directly select this expense for update
- `Delete` - directly select this expense for deletion

**Report:** Reads Report section + Balance section, formats as markdown

### Rent Management (/rent)

**Conversation Flow:**
1. Ask for total rent amount -> state: `rent_state_total`
2. Ask for electric bill -> state: `rent_state_electric`
3. Ask for water bill -> state: `rent_state_water`
4. Calculate: OtherFees = Total - Electric - Water
5. Payer = current user's @username

**Weighted Splitting (reads from Members section O:Q):**
- Electric/Water: Split by member weight
- Other Fees: Split equally among members
- Formula: `memberShare = (amount * memberWeight) / totalWeight`

**Writes to cells:** J5 (electric), J6 (water), J7 (other), J8 (total), M8 (payer)

**Message displays:** Summary + per-member breakdown with weighted shares

### Housework Management (/housework)

**Task Rotation Logic:**
- Tasks have frequency (days), assignee, and TurnsRemaining
- When marked done:
  1. Set LastDone = today
  2. Set NextDue = today + frequency
  3. Rotate assignee to next member (round-robin)
- "Assign to other" skips current assignee without updating dates

**Shortcut Commands:** `/hw1`, `/hw2`, etc. mark task 1, 2 as done directly

**Due Notifications:**
- Cron runs at 18:30 daily
- Checks all tasks where NextDue <= today
- Sends notification to task's ChannelId with assignee mention
- Can be toggled on/off at runtime via /settings command

### Settings Management (/settings)

**Main Menu:**
- Shows available settings with current status
- "Housework Reminders [ON/OFF]" button

**Housework Reminders Submenu:**
- Shows current status (ON/OFF)
- Toggle button to turn on/off
- Back button to return to main menu

**Runtime State:**
- Reminder state stored in memory (thread-safe)
- Resets to ON on bot restart

### GSheets Management (/gsheets)

**Create Monthly Sheet:**
1. Show confirmation with draft name (YYYY_MM format)
2. Duplicate "Template" sheet
3. Rename to YYYY_MM
4. Update Database!B2 with new sheet name

---

## Permission System

- Commands check `CheckPermission(bot, ctx)` before execution
- Validates chat ID against `config.Telegram.AllowedChannels`
- Public commands (no permission): /hello, /start, /feedback
- Protected: All others

---

## Data Models

```go
type Expense struct {
    ID, Name, Amount, Date, Payer string
    Participants []string
    Note string
}

type RentData struct {
    TotalBill, Electric, Water, OtherFees int64
    Payer string
    MemberShares []MemberShare  // calculated from Members weights
}

type MemberShare struct {
    Username string
    ElectricShare, WaterShare, OtherShare, TotalShare int64
}

type Task struct {
    ID int
    Name, LastDone, NextDue, Assignee, Note string
    Frequency int       // days
    TurnsRemaining int  // consecutive turns before rotation
    ChannelId int64
}

type Member struct {
    ID int
    Username string
    Weight int  // for weighted rent splitting
}
```

---

## Key Cell References (config/gsheets.go)

```go
// Database
CurrentSheetNameCell = "Database!B2"
TemplateSheetName    = "Template"

// Expenses
ExpenseStartRow      = 3
ExpenseStartCol      = "A"
ExpenseEndCol        = "G"

// Rent
RentElectricCell     = "J5"
RentWaterCell        = "J6"
RentOtherFeesCell    = "J7"
RentTotalCell        = "J8"
RentPayerCell        = "M8"

// Tasks (9 columns A-I)
SeparatedSheetTasksName = "Tasks"
TaskStartRow            = 2
TaskStartCol            = "A"
TaskEndCol              = "I"
NumberOfTasksReadRange  = "Tasks!B1"

// Members (3 columns O-Q, data starts row 4)
NumberOfMembersCell = "P2"
MembersStartRow     = 4   // Row 3 is header
MembersStartCol     = "O"
MembersEndCol       = "Q" // O=ID, P=Username, Q=Weight

// Balances
BalanceStartRow  = 13
BalanceStartCell = "I13"
BalanceEndCol    = "M"
```

---

## Commands Reference

| Command | Description | Permission |
|---------|-------------|------------|
| /start, /hello | Greeting message | Public |
| /splitbill | Expense management (add/view/update/delete/report) | Protected |
| /splitbill_add | Quick add expense | Protected |
| /rent | Add rent with utility breakdown | Protected |
| /housework | Task management with rotation | Protected |
| /hw1, /hw2, ... | Quick mark task as done | Protected |
| /gsheets | Create monthly sheets | Protected |
| /settings | Bot settings (reminder toggle) | Protected |
| /feedback | Send feedback | Public |
| /help | Show command list | Protected |
| /cancel | Cancel current conversation | Public |

---

## Telegram Bot Command List (BotFather Config)

```
splitbill - Easily split expenses with your housemates and keep track of who owes what.
splitbill_add - Add a new expense quickly and easily.
housework - Organize and delegate house chores among housemates with reminders and schedules.
hw1 - Mark the housework as done: "Giat quan ao"
hw2 - Mark the housework as done: "Do rac"
rent - Add monthly rent with breakdown (electric, water, fees)
gsheets - Manage and interact with your Google Sheets data directly from the bot.
help - Get a list of available commands and learn how to use the bot effectively.
settings - Configure your preferences and settings for a personalized experience.
cancel - Cancel the current operation and return to the main menu.
```

---

## Conversation States (enum/const.go)

| State | Used By | Description |
|-------|---------|-------------|
| `add_expense` | /splitbill add | Waiting for expense details |
| `update_expense` | /splitbill update | Waiting for updated values |
| `rent_state_total` | /rent | Waiting for total amount |
| `rent_state_electric` | /rent | Waiting for electric bill |
| `rent_state_water` | /rent | Waiting for water bill |

---

## Callback Patterns (splitbill)

| Pattern | Handler | Description |
|---------|---------|-------------|
| `splitbill.add` | StartAddSplitBill | Start add flow |
| `splitbill.view` | HandleSplitBillViewAction | View recent expenses |
| `splitbill.update` | HandleSplitBillUpdateAction | Show update list |
| `splitbill.update.{id}` | HandleSelectExpenseForUpdate | Select expense to update |
| `splitbill.delete` | HandleSplitBillDeleteAction | Show delete list |
| `splitbill.delete.{id}` | HandleSelectExpenseForDelete | Select expense to delete |
| `splitbill.delete.confirm.{id}` | HandleConfirmDelete | Confirm deletion |
| `splitbill.delete.cancel` | HandleCancelDelete | Cancel deletion |
| `splitbill.report` | HandleSplitBillReportAction | Show report |
| `splitbill.back` | HandleSplitBillBack | Return to main menu |
